---
title: "Exercise 4: Basic Geoprocessing Tools <br><small>Geographic Information Systems 1 Lab</small></br>"
author: "GEOG 3150"
output:
  html_notebook:
    df_print: paged
    rows.print: 10
    theme: cosmo
    highlight: breezedark
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
  pdf_document: default
  html_document:
    toc: yes
    df_print: paged
editor_options:
  chunk_output_type: inline
  mode: gfm
---

```{=html}
<style type="text/css">

h1.title {
  font-size: 40px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
  text-align: center;
}
h4.author { /* Header 4 - and the author and data headers use this too  */
  font-size: 20px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
  text-align: center;
}

.zoom {
  transform-origin: 40% 50% 0;
  transition: transform .2s;
  margin: 0 auto;
}
.zoom img{
	width:auto;
	height:auto;	
}
.zoom:hover {
  transform: scale(2);
}

th, td {padding: 5px;}

</style>
```
<hr></hr>

The purpose of this exercise is to help familiarize you with some of the Geoprocessing Tools available in the various programs. These tools will help you to simplify, organize, and reduce the amount of information and allow you to create additional base maps from existing data.

# The Introduction

The _Federal Emergency Management Agency_&nbsp; (FEMA) is in the process of planning for the federal distribution of resources related to natural disasters in the US. As [hurricane](https://www.noaa.gov/news-release/noaa-predicts-another-active-atlantic-hurricane-season) season approaches predictions are suggesting a very active season in the Atlantic Basin. As a FEMA analyst, you have been tasked with examining hurricane paths over the last five years that have impacted the Southeastern US. This information will be used to develop a plan for the establishment of temporary relief shelters, supply storage facilities, and mobile medical services that will be necessary in the hardest hit areas.

In this exercise you will:

-   Use various methods of geoprocessing
-   Create derived datasets
-   Adjust the coordinate systems
-   Create inset maps
-   Use the attribute table for labeling

Software specific directions can be found for each step below. Please submit the answer to the questions and your final map by the due date.

## Step One: The Data

The data you will be using for this exercise comes from the National Oceanic and Atmospheric Administration - [Office for Coastal Management](https://coast.noaa.gov/), [Historical Hurricane Tracks interactive map](https://coast.noaa.gov/hurricanes/). Information on the site is derived from the NOAA National Hurricane Center [HURDAT2](https://www.nhc.noaa.gov/data/#hurdat) and NOAA National Centers for Environmental Information [IBTrACS](https://www.ncdc.noaa.gov/ibtracs/) data sets.

<details>
<summary><big>View Directions in <b> [ArcGIS Pro]{style="color:#ff4500"} </b></big></summary>

As you have done with each of the previous exercises, [Exercise 2](https://chrismgentry.github.io/GIS1-Exercise-2/) and [Exercise 3](https://chrismgentry.github.io/GIS1-Exercise-3/), you will begin by launching **[ArcGIS Pro]{style="color:#ff4500"}** from the start menu or dekstop shortcut. Select **Map** from _New > Blank Templates_ and on the resulting screen provide a name and location for your project. Remember it would be beneficial to keep all of these exercises in a single folder on your computer. 

With your screen now displaying the _World Topographic Map_&nbsp; and _World Hillshade_&nbsp; in the table of contents, navigate to GitHub and download **[all datasets for this exercise here](https://github.com/chrismgentry/GIS1-Exercise-4/tree/main/Data)** to your project folder and extract the data. If you have any questions on how to retrieve and extract the data refer to [Exercise 2, Step 1](https://chrismgentry.github.io/GIS1-Exercise-2/#11_Step_One:_The_Data) for detailed instructions.

Add the _states_, _counties_, and all _hurricanes_&nbsp; datasets to the map view. Remember that the layers in your _Table of Contents_&nbsp; are drawn in the order they appear. So the first item on the list will be the first show, followed, by the second and so on. Therefore, if you want certain datasets to be visible above all others it should be located at the top by clicking and dragging the data up or down in the list. For polygons, you can edit the fill and transparency (found under the appearance tab in effects) to allow for items underneath to be scene. For example, in the image below, the hurricane tracks are ordered by year and are situated on top of the county and state polygons. If the polygons were drawn first, the hurricane tracks would not be shown once they make landfall. In this example, the states polygons are displayed with a hollow fill and white border to allow for the counties to show through with their black borders.

<p align="center"><div class="zoom"><img src= "Images/arcgis-ex4-data.jpg" alt="Ex4 Datasets" style="width:100%"></div></p>

Refer back to previous exercises to review how to change the symbology for a given dataset. You should experiment with different order, fill, and transparencies to customize your view of the data.

Because FEMA is only interested in counties impacted by hurricanes, you need to select only the states that are intersected by the tracks. There are several ways to subset data in [ArcGIS Pro]{style="color:#ff4500"}. For this example we can select counties by name through a structured query language (SQL), we can use graphical tools to select data, and we can use geoprocessing tools to subset the data. Because this is a learning module, you will be learning several different techniques. While this might not necessarily be the quickest method, the purpose of this exercise is to introduce you to several tools you can use as appropriate in future projects. 

To continue gathering data for this exercise you are first going to isolate the data you want to select. In the _Table of Contents_ click the **List by Selection** button <img src= "Images/arcgis-list-selection-button.jpg" alt="List by Selection" width = "20" height = "20"> to show a list of the selectable datasets in the project. Because you should have a number of datasets in the project, to isolate only the states file, right-click on the _USA_States_Continental_&nbsp; and chose "Make this the only selectable layer". 

<p align="center"><div class="zoom"><img src= "Images/arcgis-make-selectable.png" alt="Make data selectable" style="width:100%"></div></p>

To begin, click the drop-down menu for _Select_&nbsp; on the _Map Tab_&nbsp; and choose **Lasso** from the drop-down menu and and use the cursor to draw a circle encompassing Alabama, Arkansas, Delaware, Florida, Georgia, Illinois, Indiana, Kentucky, Louisiana, Maryland, Mississippi, Missouri, New Jersey, North Carolina, Ohio, Pennsylvania, South Carolina, Tennessee, Virginia, and West Virginia. Your circle does not need to include all of the state, just a small portion. See the example below:

<p align="center"><div class="zoom"><img src= "Images/arcgis-lasso-select.png" alt="Lasso Select Tool" style="width:100%"></div></p>

With the states selected, return the Table of Contents to the "List by Drawing Order" button <img src= "Images/arcgis-list-draw-button.jpg" alt="List by Drawing Order" width = "20" height = "20"> and right-click on the _USA_States_Continental_&nbsp; dataset and choose **Data > Export Features** from the menu. In the resulting menu include the following options and click OK:

- _Input Features_ = USA_States_Continental
- _Output Location_ = Select a folder for the export. It it important that you do not click into the folder, simply click once to select and click OK (see example).
- _Output Name_ = choose a name for your file and add .shp behind it to create a shapefile.

<p align="center"><div class="zoom"><img src= "Images/arcgis-export-data.png" alt="Export Data" style="width:100%"></div></p>

When finished you should have the file added to your project. Another technique to isolate data is by using the **Clip** analysis tool. This tool can be used to cut out a piece of one dataset using one or more of the features in another dataset as a "cookie cutter". This is useful for creating a new dataset that contains a geographic subset of the features in another larger dataset.

<p align="center"><img src= "Images/arcgis-clip-illustration.png" alt="ArcGIS Pro Clip Illustration" width="515" height="202"><figcaption><small><b>Illustration from https://pro.arcgis.com/en/pro-app/latest/tool-reference/analysis/clip.htm</b></small></figcaption></p>

Under the _Analysis Tab_, click the **Tools** button <img src= "Images/arcgis-toolbox-button.jpg" alt="Geoprocessing Tools Button" width="20" height="20"> to open a geoprocessing search menu. In the search box at the top of the menu type in the word **Clip** and click enter. The first option will show "**Clip** (Analysis Tools)". Click on the tool to open the associated menu. In the new menu choose the following options from the drop-down menus and click Run :

- _Input Features_ = USA_Counties
- _Clip Features_ = ex4_States (or the name of the file for the selected states in the previous step)
- _Output Feature Class_ = choose a name for your file and add .shp behind it to create a shapefile.

<p align="center"><div class="zoom"><img src= "Images/arcgis-clip-tool.png" alt="Clip Analysis Tool" style="width:100%"></div></p>

This will create a dataset containing only the counties that are included within the states used as the selection. While the colors were altered to highlight the changes and additions to the project, you should now see a new dataset in your Table of Contents that only contains those counties. 

<p align="center"><div class="zoom"><img src= "Images/arcgis-clipped-data.png" alt="Clipped Counties" style="width:100%"></div><figcaption><small><b>Colors altered from previous images to highlight geoprocessing results.</b></small></figcaption></p>

Finally, while having the individual hurricane tracks can be important, for the purposes of this exercise you are going to use the **Merge** tool to combined all of the individual hurricane tracks into a single dataset. Similar to the previous step, click on the _Tools_&nbsp; button on the Analysis Tab and search for **Merge**. Click on "**Merge** (Data Management Tool)" and in the new window choose the following options from the drop-down menu and click run:

- _Input Datasets_ = Either from the drop-down menu or the _add many button_&nbsp; <img src= "Images/arcgis-add-many-button.jpg" alt="Add Many" width = "10" height = "10"> select all of the individual hurricane tracks. If using the "add many" button you will need to click the "add" link in the bottom right-hand corner of the input. If you use the drop-down menu the data will add automatically
- _Output Dataset_ = choose a name for your file and add .shp behind it to create a shapefile.

<p align="center"><div class="zoom"><img src= "Images/arcgis-merged-data.png" alt="Merged Hurricanes" style="width:100%"></div></p>

Now you can remove the _USA_Counties_&nbsp; and all the individual hurricane track files to reduce the clutter in your Table of Contents. To do this you simply right-click on the dataset in the Table of Contents and click _Remove_.

<big><b>Question No. 1</b></big>
<blockquote>
How many individual track segments are contained in the merged hurricane dataset?
</blockquote>

</details>
<hr></hr>

<details>
<summary><big>View directions in <b> [QGIS]{style="color: #006400"} </b></big></summary>

As you have done with each of the previous exercises, [Exercise 2](https://chrismgentry.github.io/GIS1-Exercise-2/) and [Exercise 3](https://chrismgentry.github.io/GIS1-Exercise-3/), you will begin by launching <b>[QGIS]{style="color: #006400"}</b> from the start menu, launchpad, or dekstop shortcut. Start with a _New Empty Project_&nbsp; and save it to your project folder. 

With your your empty project created, navigate to GitHub and download **[all datasets for this exercise here](https://github.com/chrismgentry/GIS1-Exercise-4/tree/main/Data)** to your project folder and extract the data. If you have any questions on how to retrieve and extract the data refer to [Exercise 2, Step 1](https://chrismgentry.github.io/GIS1-Exercise-2/#11_Step_One:_The_Data) for detailed instructions.

Add the _states_, _counties_, and all _hurricanes_&nbsp; datasets to the map view. Remember that the datasets in your _Layers_&nbsp;menu are drawn in the order they appear. So the first item on the list will be the first show, followed, by the second and so on. Therefore, if you want certain datasets to be visible above all others it should be located at the top by clicking and dragging the data up or down in the list. For polygons, you can edit the fill and transparency (found under the appearance tab in effects) to allow for items underneath to be scene. For example, in the image below, the hurricane tracks are ordered by year and are situated on top of the county and state polygons. If the polygons were drawn first, the hurricane tracks would not be shown once they make landfall. In this example, the states polygons are displayed with a hollow fill and white border to allow for the counties to show through with their black borders.

<p align="center"><div class="zoom"><img src= "Images/qgis-ex4-data.png" alt="Exercise 4 Datasets" style="width:100%"></div></p>

Refer back to previous exercises to review how to change the symbology for a given dataset. You should experiment with different order, fill, and transparencies to customize your view of the data.

Because FEMA is only interested in counties impacted by hurricanes, you need to select only the states that are intersected by the tracks. There are several ways to subset data in [QGIS]{style="color: #006400"}. For this example we can select counties by name through a structured query language (SQL), we can use graphical tools to select data, and we can use geoprocessing tools to subset the data. Because this is a learning module, you will be learning several different techniques. While this might not necessarily be the quickest method, the purpose of this exercise is to introduce you to several tools you can use as appropriate in future projects.

To continue gathering data for this exercise you are first going to isolate the data you want to select. Begin by clicking on the _USA_States_Continental_&nbsp; dataset to make it the only selectable layer. Next, suing the **Select Features ** tool <img src= "Images/qgis-select-features-tool.jpg" alt="Select Features Tool" width = "20" height = "20"> use the drop-down menu to choose **Select Features by Freehand**.

<p align="center"><img src= "Images/qgis-freehand-select-tool.jpg" alt="Freehand Select" style="width:50%"></p>

Single click on the map somewhere in the Gulf of Mexico and use the cursor to draw a circle encompassing Alabama, Arkansas, Delaware, Florida, Georgia, Illinois, Indiana, Kentucky, Louisiana, Maryland, Mississippi, Missouri, New Jersey, North Carolina, Ohio, Pennsylvania, South Carolina, Tennessee, Virginia, and West Virginia. Your circle does not need to include all of the state, just a small portion. After circling the selected states, single click again to finish the selection. See the example below:

<p align="center"><div class="zoom"><img src= "Images/qgis-data-selection-tool.png" alt="Data Selection" style="width:100%"></div></p>

If you make a mistake you can use the _Deselect Features_ button <img src= "Images/qgis-clear-selection-button.png" alt="Clear Select Features Tool" width = "20" height = "20"> to clear your selection and try again. With the states selected, return the Layers menu right/CRTL click on the USA_States_Continental dataset and choose **Export > Save Selected Features As...** from the menu. In the resulting menu include the following options and click OK:

- _Format_ = ESRI Shapefile
- _File name_ = choose a name and location for your file by clicking on the <img src= "Images/qgis-folder-select-button.jpg" alt="Select Folder and File Name" width = "20" height = "20"> button
- Leave all other options as the default

<p align="center"><div class="zoom"><img src= "Images/qgis-export-selection.png" alt="Export Data Selection" style="width:100%"></div></p>

When finished you should have the file added to your project. Another technique to isolate data is by using the **Clip** analysis tool. This tool can be used to cut out a piece of one dataset using one or more of the features in another dataset as a "cookie cutter". This is useful for creating a new dataset that contains a geographic subset of the features in another larger dataset.

<p align="center"><img src= "Images/arcgis-clip-illustration.png" alt="ArcGIS Pro Clip Illustration" width="515" height="202"><figcaption><small><b>Illustration from https://pro.arcgis.com/en/pro-app/latest/tool-reference/analysis/clip.htm</b></small></figcaption></p>

On the menu bar, select **Vector > Geoprocessing Tools > Clip** to open the clipping dialog box. Choose the following options and click Run at the bottom of the screen when finished:

- _Input layer_ = USA_Counties
- _Overlay layer_ = The file of selected states you created above
- _Clipped_ = When creating new datasets you can choose to leave this section a _Create temporoary layer_ or use the <img src= "Images/qgis-folder-select-button.jpg" alt="Select Folder and File Name" width = "20" height = "20"> button to choose _Save to File..._. Temporary layers are great when you need to create an intermediate layer you do not plan to retain for analysis. In this case, because we want to keep the file, it is best to save it as a new shapefile. Any temporary file created will be lost once you close the project.

<p align="center"><div class="zoom"><img src= "Images/qgis-clip-tool.png" alt="Clip" style="width:100%"></div></p>

This will create a dataset containing only the counties that are included within the states used as the selection. While the colors were altered to highlight the changes and additions to the project, you should now see the new dataset in your Layers menu that only contains those counties.

<p align="center"><div class="zoom"><img src= "Images/qgis-clipped-data.png" alt="Clipped Data" style="width:100%"></div><figcaption><small><b>Colors altered from previous images to highlight geoprocessing results.</b></small></figcaption></p>

Finally, while having the individual hurricane tracks can be important, for the purposes of this exercise you are going to use the **Merge vector layers** tool to combined all of the individual hurricane tracks into a single dataset. To locate this tool you will need to click the _Toolbox_&nbsp; button <img src= "Images/qgis-toolbox-button.jpg" alt="Processing Toolbox Button" width = "20" height = "20"> on the toolbar. This will open the **Processing Toolbox** side menu and allow you to search for merge.

Double click on the **Merge vector layers** tool and in the new window click the <img src= "Images/qgis-folder-select-button.jpg" alt="Select Folder and File Name" width = "20" height = "20"> button for the _Input layers_. The window will shift to allow you to select all of the individual hurricane track layers. When complete click the return arrow <img src= "Images/qgis-input-layers-return-button.jpg" alt="Select Folder and File Name" width = "20" height = "20"> to go back to the Merge Vector Layers dialog box. The _Input layers_&nbsp; should now say "5 inputs selected." Next, click the <img src= "Images/qgis-folder-select-button.jpg" alt="Select Folder and File Name" width = "20" height = "20"> button for the section that says _Merged_. While you could make this a temporary layer, it would be best to save the file similar to in the previous steps to retain access to the new dataset.

<p align="center"><div class="zoom"><img src= "Images/qgis-merge-dialog2.png" alt="Merged Vector Layers Dialog" style="width:100%"></div></p>

Now you can remove the _USA_Counties_&nbsp; and all the individual hurricane track files to reduce the clutter in your Layers menu. To do this you simply right/CRTL-click on the dataset in the Layers menu and click _Remove Layer_ or hiding the layer by unchecking the _hide layer_&nbsp; button <img src= "Images/qgis-hide-layer-button.jpg" alt="Hide Layer Button" width = "20" height = "20">. 

<p align="center"><div class="zoom"><img src= "Images/qgis-merged-data.png" alt="Merged Data Example" style="width:100%"></div></p>

<big><b>Question No. 1</b></big>
<blockquote>
How many individual track segments are contained in the merged hurricane dataset?
</blockquote>

</details>
<hr></hr>

<details><summary><big>View directions in <b> [R]{style="color: #6495ED"} </b></span></big></summary>
Before you begin, you will need to open the [Ex4 Colab Notebook](https://github.com/chrismgentry/GIS1-Exercise-4/blob/main/GIS1_EX4.ipynb) and insert **tocolab** after _github_ in the URL to open in the _Colab Environment_. If you have any questions regarding Colab Notebooks refer to [Exercise 2, Introduction](https://chrismgentry.github.io/GIS1-Exercise-2/) for <b>[R]{style="color: #6495ED"}</b>. Remember to make a copy of the notebook. As you have seen before, R requires various packages to complete certain analyses. In this exercise you will be using **tidyverse, ggsn, cowplot, maps, mapproj, plyr, raster, rgeos, rgdal, sp)**. This is a large number of packages and will take a while to load. To install and load the packages we will use the following script:

```{r install packages, echo=TRUE, message=FALSE, warning=FALSE}
#install.packages('tidyverse')
#install.packages('ggsn')
#install.packages('cowplot')
#install.packages('maps')
#install.packages('mapproj')
#install.packages('plyr')
#install.packages('raster')
#install.packages('rgeos')
#install.packages('rgdal')
#install.packages('sp')
library('tidyverse')
library('ggsn')
library('cowplot')
library('maps')
library('mapproj')
library('plyr')
library('raster')
library('rgeos')
library('rgdal')
library('sp')
library('utils')
```

In future exercises you will learn how to reduce the script above to load and install packages in fewer lines. Additionally, there are certain functions that are duplicated between different packages. Therefore, in this exercise you will learn to use **::** (double colons) to indicate which package you want to execute a specific function.

For this exercise you will use a combination of built in data from various packages and downloaded data from the above sources in the form of a shapefile. A [shapefile](https://desktop.arcgis.com/en/arcmap/latest/manage-data/shapefiles/what-is-a-shapefile.htm) is a "simple, non-topological format for storing the geometric location and attribute information of geographic features. Features can be represented by points, lines, or polygons. The workspace containing shapefiles may also contain a database manage table, which can store additional attributes that can be joined to a shapefiles features."

In previous exercises you created relatively simplistic maps and design layouts. More fully developed maps contain additional geographic data, or base maps, that can be used to provide reference or location information. In this exercise you will also create an inset map or reference map that provides an overview.

To begin, you will use the information from the _maps package_ to create an object containing the states of Alabama, Arkansas, Delaware, Florida, Georgia, Illinois, Indiana, Kentucky, Louisiana, Maryland, Mississippi, Missouri, New Jersey, North Carolina, Ohio, Pennsylvania, South Carolina, Tennessee, Virginia, and West Virginia. The process is similar to the directions for [Exercise 2, Step 1](https://chrismgentry.github.io/GIS1-Exercise-2/#11_Step_One:_The_Data) and [Exercise 3, Step 1](https://chrismgentry.github.io/GIS1-Exercise-3/#11_Step_One:_The_Data).

```{r se states, echo=TRUE, message=FALSE, warning=FALSE}
states <- map_data(map = "state", region =  c("alabama","arkansas","delaware","florida","georgia",
                                              "illinois","indiana","kentucky","louisiana","maryland",
                                              "mississippi","missouri","new jersey","north carolina","ohio",
                                              "pennsylvania","south carolina","tennessee","virginia","west virginia"))

ggplot(states) + 
  geom_polygon(aes(x=long, y=lat, group=group), color = "white") +
  coord_fixed()
```
To add contextual data and avoid the appearance of "floating data" you will next create an object to fill in the surrounding states.

```{r us states, echo=TRUE, message=FALSE, warning=FALSE}
us <- map_data('state')

ggplot() + 
  geom_polygon(data = us, aes(x=long, y=lat, group=group), color = "white", fill = "gray") + 
  geom_polygon(data = states, aes(x=long, y=lat, group=group), color = "white") + 
  coord_fixed()
```
To add the hurricane information from NOAA you need to download the shapefiles, extract the dataset, and read in the files. To do this you will use the ```readOGR``` function from the **[rgdal](https://www.rdocumentation.org/packages/rgdal/versions/1.5-23/topics/readOGR)** package. You will use the `download.file` function and github link to obtain the zip file and the `unzip` function to extract the data. The `readOGR` function requires listing the path to the file to import that data. In the path below you will see a **.** (period) in front of the /Hurricanes folder. The period is a shortcut version to say "in the project folder" instead of typing out the entire folder path.

```{r NOAA data, echo=TRUE, message=FALSE, warning=FALSE}
download.file('https://github.com/chrismgentry/GIS1-Exercise-4/raw/main/Data/Hurricanes.zip', 'hurricanes.zip')
unzip('hurricanes.zip')

dorian <- readOGR("./Hurricanes","Dorian_2019_line")
irma <- readOGR("./Hurricanes","Irma_2017_line")
laura <-readOGR("./Hurricanes","Laura_2020_line") 
matthew <-readOGR("./Hurricanes","Matthew_2016_line") 
michael <-readOGR("./Hurricanes","Michael_2018_line")
```

Next you will use the `rbind` function, which is a base R function, to combine all of the individual tracks into one. However, because of the structure of the data there are some additional steps that need to be taken before the data can be used in `ggplot2`. The first is to create a column of row ids for each row to use in a future step to connect the data. Then the `fortify` function from **ggplot2** can be used to convert the data to an object that can be imported into the map. Finally, the `join` function from the **plyr** package can be used to attach the data lost in the conversion from the original dataset to the new ggplot2 ready dataset.

```{r combine hurricanes, echo=TRUE, message=FALSE, warning=FALSE}
hurricanes <- rbind(dorian,irma,laura,matthew,michael)
hurricanes@data$id <- rownames(hurricanes@data)
sp_hurricanes <- fortify(hurricanes)
hurricane_tracks <- plyr::join(sp_hurricanes,hurricanes@data, by = "id")
```

Next you will take similar steps to download and extract a counties shapefile, subset the counties to include those in the selected states above, and finally, prepare the dataset for use with `ggplot2`.

```{r counties data, echo=TRUE, message=FALSE, warning=FALSE}
download.file('https://github.com/chrismgentry/GIS1-Exercise-4/raw/main/Data/US_Counties.zip', 'counties.zip')
unzip('counties.zip')

counties <- readOGR(".","USA_Counties")
subset_counties <- counties[counties$STATE_NAME == "Alabama" | counties$STATE_NAME == "Arkansas"|
                                counties$STATE_NAME == "Delaware" | counties$STATE_NAME == "Florida"|
                                counties$STATE_NAME == "Georgia" | counties$STATE_NAME == "Illinois"|
                                counties$STATE_NAME == "Indiana" | counties$STATE_NAME == "Kentucky"|
                                counties$STATE_NAME == "Louisiana" | counties$STATE_NAME == "Maryland"|
                                counties$STATE_NAME == "Mississippi" | counties$STATE_NAME == "Missouri"|
                                counties$STATE_NAME == "New Jersey" | counties$STATE_NAME == "North Carolina"|
                                counties$STATE_NAME == "Ohio" | counties$STATE_NAME == "Pennsylvania"|
                                counties$STATE_NAME == "South Carolina" | counties$STATE_NAME == "Tennessee"|
                                counties$STATE_NAME == "Virginia" | counties$STATE_NAME == "West Virginia",]

subset_counties@data$id <- rownames(subset_counties@data)
counties_data <- fortify(subset_counties)
se_counties <- plyr::join(counties_data,subset_counties@data, by = "id")
```

Now you can use `ggplot2` to visualize the data. The steps to display the data are similar to those from [Exercise 2, Step 3](https://chrismgentry.github.io/GIS1-Exercise-2/#13_Step_Three:_The_Visualization) or [Exercise 3, Step 3](https://chrismgentry.github.io/GIS1-Exercise-3/#13_Step_Three:_The_Visualization). 

```{r first visualization, echo=TRUE, message=FALSE, warning=FALSE}
ggplot() + 
  geom_polygon(data = us, aes(x=long, y=lat, group=group), color = "white", fill = "gray") +
  geom_polygon(data = states, aes(x=long, y=lat, group=group), color = "white") +
    geom_polygon(data = se_counties, aes(x=long, y=lat, group=group), color = "darkgray", fill = "NA") +
  geom_path(data = hurricane_tracks, aes(x=long, y=lat, group=group), color = "red", size = 2) +
  coord_fixed(xlim = c(-125,-65), ylim = c(25,50))
```
Notice in the code above `coord_fixed()` is used to limit the range of the map. This will be important in future visualizations.

<big><b>Question No. 1</b></big>
<blockquote>
What variables are present in the hurricane track dataset? Which of these could be used to categorize the data in a new visualization? Answer in the code cell below.
</blockquote>

</details>

## Step Two: The Analyses

In this step you will organize and display the data in order to prepare it for the final visualization.

<details>
<summary><big>View Directions in <b> [ArcGIS Pro]{style="color:#ff4500"} </b></big></summary>

Now that you have the necessary data, you need determine which counties are most significantly impacted by the hurricanes. Because hurricane winds can impact areas far away from the eye or the storm, you will begin by creating a buffer around the hurricane tracks. You can either use the **Tools** button <img src= "Images/arcgis-toolbox-button.jpg" alt="Geoprocessing Tools Button" width="20" height="20"> on the _Analysis Tab_&nbsp; or search for **Buffer** in the list of tools next to the button. In the Buffer window select the following options and click run:

- _Input Features_ = The merged hurricane dataset
- _Output Feature Class_ = choose a name for your file and add .shp behind it to create a shapefile
- _Distance_ = 50 miles (linear unit)
- _Side Type_ = Full
- _End Type_ = Round
- _Method_ = Planar
- _Dissolve Type_ = Dissolve all output features into a single feature

<p align="center"><div class="zoom"><img src= "Images/arcgis-buffer-data.png" alt="Buffer Tool" style="width:100%"></div></p>

If in this step or the next you encounter a warning stating there is a "datum conflict between the input and output", just proceed with the exercise. We will discuss _datums_, a set of reference points on the earth's surface against which position measurements are made, in future exercises. While they are important to understand, for the purposes of this exercise you can ignore the warning.

In this next step you need to isolate only the counties that are located within this buffer. To do this, click the **Select By Location** button <img src= "Images/arcgis-select-location-button.jpg" alt="Select By Location Button" width="20" height="20"> on the _Map Tab_&nbsp; in the Selection Section. In the new menu choose the following and click OK.

- _Input Features_ = Your clipped counties
- _Relationship_ = Choose Intersect
- _Selecting Features_ = Your buffered hurricanes
- _Selection Type_ = New Selection

<p align="center"><div class="zoom"><img src= "Images/arcgis-select-by-location.png" alt="Select By Location" style="width:100%"></div></p>

With this selection made, you can take the same steps as before to create a new dataset by right-clicking on the clipped counties dataset in the Table of Contents, going to _Data > Export Features_&nbsp; and creating a new shapefile of the selected counties. You can now remove the clipped counties you created in step one or change the symbology to make this new selection stand out.

To answer the following question, open the attribute table for the new dataset you created highlighting the impacted counties. Right-click on the column header for the **Population** variable, and select statistics.

<big><b>Question No. 2</b></big>
<blockquote>
What is the total population (sum information) of the counties impacted by these hurricanes?
</blockquote>

</details>
<hr></hr>

<details>
<summary><big>View Directions in <b> [QGIS]{style="color:#006400"} </b></big></summary>

Now that you have the necessary data, you need determine which counties are most significantly impacted by the hurricanes. Because hurricane winds can impact areas far away from the eye or the storm, you will begin by creating a buffer around the hurricane tracks. You can either go to **Vector > Geoprocessing Tools > Buffer** on the menu bar or search for **Buffer** in the _Processing Toolbox_&nbsp; (similar to searching for Merge). Double-click on the Buffer tool, select the following options and click Run:

<p align="center"><img src= "Images/qgis-buffer-analysis.png" alt="Buffer Tool Dialog" style="width:75%"></p>

- _Input layer_ = The merged hurricane file you created
- _Distance_ = 0.8
- _Segments_ = 4
- _End cap style_ = Round
- _Join style_ = Round
- _Miter limit_ = 2.0
- Check the box for _Dissolve result_
- _Buffered_ save the file in your project folder

You may receive a warning about using degrees to calculate the buffer. If so you can dismiss it for now. In future exercises you will project your dataset, however for the purposes of this exercise you can ignore the warning. Your screen should now look similar to this (colors have been altered to highlight the results):

<p align="center"><div class="zoom"><img src= "Images/qgis-buffered-data.png" alt="Buffered hurricane dataset" style="width:100%"></div></p>

For this exercise, you are going to add satellite imagery from a remote connection. In the browser, scroll down to **XYZ Tiles** and right/CRTL-click to add a “New Connection”. In the resulting window name the connection “Google Satellite” and type the following into the URL:

```
https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}
```

You can now click and drag **Google Satellite** into the layer to view the satellite imagery. Remember to arrange your layer so that either the fill for counties is transparent or the satellite layer is above the counties so you can see the imagery.

<p align="center"><div class="zoom"><img src= "Images/qgis-data-with-satellite.png" alt="Adding satellite data basemap" style="width:100%"></div></p>

In this next step you need to isolate only the counties that are located within the hurricane buffer. To do this, click **Vector > Research Tools > Select By Location** from the menu bar. In the new menu choose the following and click Run

<p align="center"><img src= "Images/qgis-select-by-location.jpg" alt="Select by location tool" style="width:75%"></p>

- _Select features from_ = The clipped counties dataset. This is the file that contains only the counties in the selected states.
- _Where the features (geometric predicate)_ = Check the box for **intersect**
- _By comparing to the features from_ = The hurricane buffer dataset
- _Modify current selection by_ = Creating new selection

With this selection made, you can take the same steps as before to create a new dataset by right/CRTL-clicking on the clipped counties dataset in the Layers menu, going to **Export > Save Selected Features As...** and creating a new shapefile of the selected counties. 

<p align="center"><div class="zoom"><img src= "Images/qgis-selected-save.png" alt="Exporting the current selection" style="width:100%"></div></p>

You can now remove the clipped counties you created in step one or change the symbology to make this new selection stand out.

<p align="center"><div class="zoom"><img src= "Images/qgis-select-by-location-data.png" alt="All Analyzed Datasets" style="width:100%"></div></p>

To answer the following question, click the _Show Statistical Summary_&nbsp; button <img src= "Images/qgis-statistical-summary-button.jpg" alt="Show Statistical Summary Button" width="20" height="20"> on the menu bar. A new menu will open in the left-hand column of the screen. In this menu select the dataset you created for the hurricane impacted counties in the first box and population in the second.

<p align="center"><img src= "Images/qgis-statistics-menu.png" alt="Statistics Information" style="width:60%"></p>

<big><b>Question No. 2</b></big>
<blockquote>
What is the total population (sum information) of the counties impacted by these hurricanes?
</blockquote>

</details>
<hr></hr>

<details>
<summary><big>View Directions in <b> [R]{style="color:#6495ED"} </b></big></summary>

Now that you have the necessary data, you need determine which counties are most significantly impacted by the hurricanes. Because hurricane winds can impact areas far away from the eye or the storm, you will begin by creating a buffer around the hurricane tracks. For this step you will use the `buffer` function from the **raster** package. The function requires:

```
buffer(x,width=0,dissolve=TRUE)
```
where _x_ = the dataset, _width_ = distance in map units, and _dissolve_ = if TRUE, overalpping polygons are dissolved.

```{r buffer, echo=TRUE, message=FALSE, warning=FALSE}
hurricanes_buffer <- buffer(hurricanes, width = 1, dissolve = TRUE)
```

With the buffer created you can now use [`intersect`](https://www.rdocumentation.org/packages/raster/versions/3.4-13/topics/intersect) from the **raster** package to select the overlapping counties. More information on [Intersect](https://pro.arcgis.com/en/pro-app/latest/tool-reference/analysis/intersect.htm) can be found on the [ESRI](https://pro.arcgis.com/en/pro-app/latest/tool-reference/analysis/intersect.htm) website. Similar to before, you will need to `fortify` the data and connect to the original dataset.

```{r impacted counties, echo=TRUE, message=FALSE, warning=FALSE}
intersection <- raster::intersect(hurricanes_buffer,subset_counties)
intersection@data$id <- rownames(intersection@data)
hurricanes_counties <- fortify(intersection)
impacted_counties <- plyr::join(hurricanes_counties,intersection@data, by = "id")
```

With the intersection complete, the counties that are most impacted by the hurricane (e.g. those within the buffer zone of the tracks) are contained within the _impacted_counties_ object.

<big><b>Question No. 2</b></big>
To answer this question you will need to create a dataset that won't be used in the map. Due to the dissected nature of the data, you need to examine the distinct _ids_ of the impacted counties. This can be done using the following script:

```
county_populations <- distinct(impacted_counties, FIPS, .keep_all = TRUE)
```

Where you are using the _impacted_counties_ dataset and keeping only the _distinct_ federal FIPS code that is unique to each county.
<blockquote>
With the dataset above, write a script using <b>sum()</b> to determine the total population impacted by the hurricanes?
</blockquote>
<i><small>HINT: Similar to Exercise 3, Question 2 place the object followed by a $ and the variable name between the () in the sum function. You can use <b>str()</b> to view the variables available in the dataset.</small></i>
</details>

## Step Three: The Visualization

You will now create a graphical display of your data that includes cartographic elements such as legend, scale bar, north arrow, etc. In this visualization you will also learn to add a different basemap, add an inset or overview map, and alter the projected coordinate system. 

<details><summary><big>View directions in <b> [ArcGIS Pro]{style="color:#ff4500"} </b></span></big></summary>

On the _Map Tab_&nbsp; click the **Basemap** button <img src= "Images/arcgis-basemap-button.jpg" alt="Basemaps" width="20" height="20"> and select the option for _Oceans_. Remember that the order of the datasets in the Table of Contets determines what order they are displayed.

<p align="center"><div class="zoom"><img src= "Images/arcgis-basemaps.png" alt="Basemaps" style="width:100%"></div></p>

In future exercises you may choose any of these basemap options that are apprropriate for your analyses. Next, on the _Insert Tab_&nbsp; click the button for **New Map** <img src= "Images/arcgis-new-map-button.jpg" alt="Insert New Map" width="20" height="20"> and select New Map. A new map tab (probably called Map2) will appear in your map frame. Add (or copy/paste from the original map) the hurricane impacted counties and the continental US States shapefiles as well as the Oceans basemap to this new map. Be sure to zoom in a appropriate to see the data.

<p align="center"><img src= "Images/arcgis-map2.png" alt="Inset Map" style="width:100%"></p>

To return to the original map simply click on the appropriate tab. This will allow you to switch back and forth between the two in order to make the necessary customizations. It may be beneficial to rename each one to keep track of the purpose for each map.

Next you can change the projection of the coordinate system for the inset map (Map2). In the Table of Contents, right-click on **Map2** and select _Properties_. In the resulting window click **Coordinate Systems** from the left-side menu. Under "XY Coordinate Systems Available" scroll down until you see _Projected Coordinate System_. Using the series of drop-down menus go to **Projected Coordinate System > Continental > North America** and select the option for "North America Albers Equal Area Conic" and click OK. You should notice that the awkward "flat top" border of the United States should now me curved and the overall shape of the states has a more pleasing appearance.

<p align="center"><div class="zoom"><img src= "Images/arcgis-coordinate-systems.png" alt="Altering Coordinate systems" style="width:100%"></div></p>

In lecture we will discuss the importance of projections and coordinate systems. In future exercises you should take some time to select different options to see which _Coordinate System_&nbsp; has the most pleasing shape to your eyes.

It is now time for you to make your map. Similar to **[previous exercises](https://chrismgentry.github.io/GIS1-Exercise-2/#13_Step_Three:_The_Visualization)**, you need to add all of the necessary elements discussed in Exercise 2 and 3. In this exercise you will also need to add your inset map (Map2). To do this, you first need to add the primary map with using the Map Frame button like before. Next you can click the Map Frame button again to add the second map.

<p align="center"><div class="zoom"><img src= "Images/arcgis-add-map2.png" alt="Add Inset Map" style="width:100%"></div></p>

However, for the inset you want it to be smaller and not cover your map data.

<p align="center"><div class="zoom"><img src= "Images/arcgis-map-and-inset.png" alt="Map with Inset Map" style="width:100%"></div></p>

Finalize your map by adding all of the necessary map elements (title, legend, north arrow, scale bar, name and date) and altering the symbology of the hurricane dataset to provide additional important data. Remember to renaming items in the Table of Contents will rename them in the legend.

<p align="center"><img src= "Images/arcgis-final-map.png" alt="Final Map" style="width:100%"></p>

<big><b>Question No. 3</b></big>
<blockquote>
How many total impacted counties are included in the new dataset?
</blockquote>

</details>
<hr></hr>

<details><summary><big>View directions in <b> [QGIS]{style="color:#006400"} </b></span></big></summary>

To create this visualization you are going to also create what is called an inset or indicator map. These are smaller maps that are used to provide additional detail about a specific location. These maps are often small scale versions or the primary map, but sometimes can be larger scale to enhance detail in congested areas. In this case it will be a small scale version of the continental US.

To begin this process you are going to create some organizations in the Layer Menu by using the **Add Group** button <img src= "Images/qgis-layers-add-group.jpg" alt="Add Groups" width="20" height="20">. Name the first group "Main Map" and create a second group called "Inset Map". 

<p align="center"><img src= "Images/qgis-layers-menu-groups.jpg" alt="Layers Groups" style="width:60%"></p>

In the Layers Menu you can click and drag the datasets into the different groups as well as right/CRTL-click to copy and paste. For this exercise you should order your datasets as follows:

- **Main Map**
  - Hurricanes Dataset
  - Hurricane Impacted Counties
  - Selected States
  - Clipped Counties
  - Continental US
  - Google Satellite Imagery
- **Inset Map**
  - Hurricane Buffer
  - Selected States
  - Continental US
  - Google Satellite Imagery

<p align="center"><img src= "Images/qgis-layers-with-groups.jpg" alt="Layers Groups" style="width:60%"></p>

Similar to **[previous exercises](https://chrismgentry.github.io/GIS1-Exercise-2/#13_Step_Three:_The_Visualization)**, your visualization should include all of the necessary map elements discussed in Exercise 2 and 3. However, you will also need to add the inset map for this exercise. To do this, you first need to create a _New Print Layout_, and with the "Main Map" selected and the "Inset Map" hidden in the Layers Menu, and add the map with the _Add map_&nbsp; tool like before. 

<p align="center"><div class="zoom"><img src= "Images/qgis-layout-main-map.png" alt="Layout with Main Map" style="width:100%"></div></p>

In the item properties for the map, set your level of zoom and align the map in your desired location. Then under _Layers_&nbsp; section, click "Lock Layers" to keep the map frame from being altered. You can always return to this layer and unlock it if you need to make changes.

Next return to the project and turn off the Main Map, then turn on the Inset Map and return to the layout and add another map. Because you have the inset group selected and the main map group hidden, the additional map frame will contain the inset information. Remember to think about where you want the inset to be located before you draw it on the layout. While you can change this at anytime, you should always have a planned map design.

<p align="center"><div class="zoom"><img src= "Images/qgis-layout-inset-map.png" alt="Layout with Inset Map" style="width:100%"></div></p>

Finalize your map by adding all of the necessary map elements (title, legend, north arrow, scale bar, name and date) and altering the symbology of the hurricane dataset to provide additional important data. Remember to renaming items in the Table of Contents will rename them in the legend but you will need to update in the item properties. Alternatively, in the item properties for the legend you can select any object and click the Edit button <img src= "Images/qgis-edit-item-properties-button.jpg" alt="Add Groups" width="20" height="20"> to rename them.

<big><b>Question No. 3</b></big>
<blockquote>
How many total impacted counties are included in the new dataset?
</blockquote>

</details>
<hr></hr>

<details><summary><big>View directions in <b> [R]{style="color:#6495ED"} </b></span></big></summary>

To create this visualization you are going to also create what is called an inset or indicator map. These are smaller maps that are used to provide additional detail about a specific location. These maps are often small scale versions or the primary map, but sometimes can be larger scale to enhance detail in congested areas. In this case it will be a small scale version of the continental US.

To begin this process you are going to create an additional object for countries of the world.

```{r world, echo=TRUE, message=FALSE, warning=FALSE}
world <- map_data(map = "world")
```

You can now create the primary map data. Within the script below you will see some of the common functions used throughout this and previous exercises. There are two changes made from the typical `ggplot2` script to mention:

- geom_path() is a function to add a line based on a series of data points such as hurricane tracks.
- Within the aes() for geom_path() the color variable was converted to a character (letters) from numeric (numbers). This was done to create discrete variables rather than continuous variables to make a more appropriate legend.

```{r main map, echo=TRUE, message=FALSE, warning=FALSE}
main_map <- ggplot() + 
  geom_polygon(data = world, aes(x=long, y=lat, group=group), color = NA, fill = "gray") +
  geom_polygon(data = us, aes(x=long, y=lat, group=group), color = "white", fill = "DimGray") +
  geom_polygon(data = se_counties, aes(x=long, y=lat, group=group), fill = "LightGray", color = "DarkGray") +
  geom_polygon(data = states, aes(x=long, y=lat, group=group), color = "black", fill = NA) +
  geom_polygon(data = impacted_counties, aes(x=long, y=lat, group=group), color = "DarkGray", fill = "LightSkyBlue") +
  geom_path(data = hurricane_tracks, aes(x=long, y=lat, group=group, color = as.character(SS)), size = 2, lineend = "round") +
  scale_color_viridis_d(option = "A", "Saffir\nSimpson\nScale") +
  coord_fixed(xlim = c(-97,-74), ylim = c(25,44)) + 
  theme(axis.title.x=element_blank(), axis.title.y=element_blank(), panel.background = element_rect(fill = "lightblue"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())
main_map
```

To create the inset map you will use the _world_ data you created above along with the US and impacted counties datasets.

```{r inset map, echo=TRUE, message=FALSE, warning=FALSE}
inset <- ggplot() + 
  geom_polygon(data = world, aes(x=long, y=lat, group=group), color = "white", fill = "gray") +
  geom_polygon(data = us, aes(x=long, y=lat, group=group), color = "black", fill = "DarkGray") +
  geom_polygon(data = impacted_counties, aes(x=long, y=lat, group=group), color = NA, fill = "LightSkyBlue") +
  coord_map(xlim = c(-125,-65), ylim = c(25,50), "conic", lat0 = 30) +
  theme(panel.background = element_rect(fill = "lightblue"), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        axis.line=element_blank(), axis.text.x=element_blank(), axis.text.y=element_blank(),axis.ticks=element_blank(), 
        axis.title.x=element_blank(), axis.title.y=element_blank())
inset
```

Notice in each of these scripts created an object out of the ggplot(). This is used to facilitate the creation of the final map when overlaying the inset on the main map. To do this you will use `ggdraw` from the **ggplot2** package. In this function to add the maps using the `draw_plot` function and locate the inset using _x_, _y_, _width_, and _height_ arguments. These values can be altered to move the inset map to any location on the main map. Feel free to experiment with location in Step 4.

```{r step 3 map, echo=TRUE, message=FALSE, warning=FALSE}
ggdraw() +
draw_plot(main_map) + 
draw_plot(inset, x = 0.105, y = 0.72, width = 0.275, height = 0.275)
```
There may be a discrepancy between the x, y, width, and height information for the inset in the script above and the Colab Notebook due to the differences in resolution and space limitations of creating the webpage. 

<big><b>Question No. 3</b></big>
<blockquote>
Provide the full script you would use to add the north arrow, title, scalebar, and name/date information to the map.
</blockquote>

</details>

## Step Four: Your Turn

After providing the initial map to FEMA, the Deputy Associate Administrator for the Office of Response and Recovery has asked if you could add some additional data. Specifically, they are interested in cities with a population of greater than 300,000 so they are able to situate response teams in proximity to the most people.

<details><summary><big>View directions in <b> [ArcGIS Pro]{style="color:#ff4500"} </b></span></big></summary>

If you did not previously download the [cities data](https://github.com/chrismgentry/GIS1-Exercise-4/raw/main/Data/US_Cities_100k.zip) from the GitHub Exercise Page please download the data and unzip it in your project folder. With that data available, add the US_Cities_100k.shp to your primary map (not the inset map). Repeating the steps to **clip** from [Step 1](https://chrismgentry.github.io/GIS1-Exercise-4/#11_Step_One:_The_Data) select the cities as your _Input Feature_, the hurricane buffer as the _Clip Feature_, and be sure to save the new dataset to your project folder with .shp to create a shapefile. You can now remove the US Cities from the project but keep your clipped cities.

While you will leave all of the clipped cities on the map, you will now create a _Label Class_ to only create labels for cities with a population greater than 300,000. To begin, right-click on your new clipped cities dataset and select "Labeling Properties..." <img src= "Images/arcgis-labeling-properties.jpg" alt="Labeling Properties" width="150" height="20"> from the options.

Under the "Class" option in the Label Class window select **SQL** from the three options. Next select _New expression_&nbsp; <img src= "Images/arcgis-new-expression-labels.jpg" alt="Labeling SQL" width="115" height="20"> and select the following options:

<p align="center">Where&emsp;**POPULATION**&emsp;**is greater than**&emsp;**300,000**</p>

<p align="center"><img src= "Images/arcgis-labeling-sql.png" alt="SQL Options for Labeling" style="width:50%"></p>

When complete, click **Apply** at the bottom of the window. Use the options on the _Labeling Tab_ for the dataset to adjust the label field to NAME, change the font or size of the text, and click the **Label** button on the left of the tab.

<p align="center"><div class="zoom"><img src= "Images/arcgis-labeling-tab.jpg" alt="Labeling Options" style="width:100%"></div></p>

<big><b>Question No. 4</b></big>
<blockquote>
What labeled cities are the furthest North, South, East, and West?
</blockquote>

</details>
<hr></hr>

<details><summary><big>View directions in <b> [QGIS]{style="color:#006400"} </b></span></big></summary>

If you did not previously download the [cities data](https://github.com/chrismgentry/GIS1-Exercise-4/raw/main/Data/US_Cities_100k.zip) from the GitHub Exercise Page please download the data and unzip it in your project folder. With that data available, add the US_Cities_100k.shp to your primary map (not the inset map). Repeating the steps to **clip** from [Step 1](https://chrismgentry.github.io/GIS1-Exercise-4/#11_Step_One:_The_Data) select the cities as your _Input Layer_, the hurricane buffer as the _Overlay Layer_, and be sure to save the new dataset to your project folder in the _Clipped_&nbsp; option. You can now remove the US Cities from the project but keep your clipped cities.

While you will leave all of the clipped cities on the map, you will now create a Label Class to only create labels for cities with a population greater than 300,000. To begin, right/CRTL-click on your new clipped cities dataset and select “Properties”. Under the **Labels** tab on the left side of the new window, select _Rule-based Labeling_&nbsp; from the drop-down menu at the top of the window. Next, click the <b>[Green +]{style="color:#006400"}</b> at the bottom to add a new rule. Provide the following inputs and click OK

- _Description_ = Give your rule a name
- _Filter_ = Type the following: ``` "POPULATION" > 300000```
- _Labels_ = Check this box
- _Value_ = NAME
- _Text, Formatting, Buffer, Mask, etc._ = Customize as necessary for your preferred style

<p align="center"><img src= "Images/qgis-rule-based-labels.png" alt="Rule-based Options for Labeling" style="width:100%"></p>

Finally, click OK on the layer properties window. You will need to return to your main map in the layout and uncheck the box for locked to update the map with this new information.

<big><b>Question No. 4</b></big>
<blockquote>
What labeled cities are the furthest North, South, East, and West?
</blockquote>

</details>
<hr></hr>

<details><summary><big>View directions in <b> [R]{style="color:#6495ED"} </b></span></big></summary>

Just like the steps above you will use the `download.file`, `unzip`, and `readOGR` functions to download the cities shapefile and extract the information. Also like above, you will need to subset the cities to include only those in the selected states.

```{r cities, echo=TRUE, message=FALSE, warning=FALSE }
download.file('https://github.com/chrismgentry/GIS1-Exercise-4/raw/main/Data/US_Cities_100k.zip', 'cities.zip')
unzip('cities.zip')

cities <- readOGR(".","US_Cities_100k")

subset_cities <- cities[cities$ST == "AL" | cities$ST == "AR"|
                              cities$ST == "DE" | cities$ST == "FL"|
                              cities$ST == "GA" | cities$ST == "IL"|
                              cities$ST == "IN" | cities$ST == "KY"|
                              cities$ST == "LA" | cities$ST == "MD"|
                              cities$ST == "MS" | cities$ST == "MO"|
                              cities$ST == "NJ" | cities$ST == "NC"|
                              cities$ST == "OH" | cities$ST == "PA"|
                              cities$ST == "SC" | cities$ST == "TN"|
                              cities$ST == "VA" | cities$ST == "WV",]
```

With the cities information available you will again use the `intersect` function to limit the cities data to only those within the hurricane buffer.

```{r buffered cities, echo=TRUE, message=FALSE, warning=FALSE }
cities_intersect <- raster::intersect(subset_cities,hurricanes_buffer)
cities_intersect@data$id <- rownames(cities_intersect@data)
se_cities <- data.frame(cities_intersect)
names(se_cities)[names(se_cities) =="coords.x1"] <- "long"
names(se_cities)[names(se_cities) =="coords.x2"] <- "lat"
```

Notice in the script above there is additional code to rename two variables: coords.x1 and coords.x2. Due to the conversion from a shapefile and the intersect, the resulting object needed to be set as a data frame. In the process the coordinate information columns were renamed coords.x1 and coords.x2. Therefore you needed to rename those individual columns to lat and long to remain consistent with the rest of your scripts. 

And finally you will create a query that selects just those cities that have a population greater than 300,000 individuals.

```{r large cities, echo=TRUE, message=FALSE, warning=FALSE }
large_cities <- se_cities[se_cities$POPULATION > 300000,]
```

Now you have a number of datasets that can be used to create your final map including:

- World
- US States
- Southeast States
- Southeast Counties
- Hurricane Impacted Counties
- Hurricane Tracks
- Southeast Cities
- Large Southeast Cities

For your final map, you need to use these datasets to create the visualization requested by FEMA above that includes the geographic information, hurricane tracks, cities, and large cities with populations greater than 300,000. In the Colab Notebok and below is an incomplete `ggplot2` script.

```
cities_map <- ggplot() + 
  geom_polygon(data = World...
  geom_polygon(data = US States...
  geom_polygon(data = SE Counties...
  geom_polygon(data = SE States...
  geom_polygon(data = Impacted Counties...
  geom_path(data = Hurricane Tracks...
  scale_color_viridis_d(option = "A", "Saffir\nSimpson\nScale") +
  geom_point(data = se_cities, aes(x=long, y=lat), color = "yellow") +
  geom_point(data = large_cities, aes(x=long, y=lat), color = "yellow") +
  geom_text(data = large_cities, aes(x=long, y=lat, label = NAME, fontface = "bold"), size = 3, 
            nudge_y = 0.60, nudge_x = 0.25, check_overlap = TRUE, color = "white") +
  annotate("text", x = -86.85, y = 38.5, label = "Louisville", fontface = "bold", size = 3, color = "white") +
  coord_sf(Limiting coordinates to focus on the SE US...
  theme(axis.title.x=element_blank(), axis.title.y=element_blank(),
        panel.background = element_rect(fill = "lightblue"), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())
cities_map
```

Complete this script in the Colab Notebook, including lines for scale bar, north arrow, title, name and date. 

<big><b>Question No. 4</b></big>
<blockquote>
What labeled cities are the furthest North, South, East, and West?
</blockquote>

</details>

# The Write-Up

In the report you provide to FEMA please provide the following information:

- Total population of the impacted counties
- Total number of large cities (all in the clipped dataset)
- Which cities above 300,000 people would need response teams
  - Based on the distribution of these, would it be possible for one response team to cover multiple large cities?

When complete, send a link to your _Colab Notebook_ or word document with answers to Questions 1-4 and your completed map via email.